{% extends 'base.html' %}
{% load static %}

<script>
document.addEventListener("DOMContentLoaded", function() {
    const images = [
        "{% static 'images/city1.jpg' %}",
        "{% static 'images/road1.jpg' %}",
        "{% static 'images/road2.jpg' %}",
        "{% static 'images/road3.jpg' %}",
        "{% static 'images/road4.jpg' %}",
        "{% static 'images/road5.jpg' %}"
    ];
    let idx = 0;
    function changeHeroBg() {
        const hero = document.querySelector('.hero');
        if (hero) {
            hero.style.background = `url('${images[idx]}') center center/cover no-repeat fixed`;
        }
        idx = (idx + 1) % images.length;
    }
    changeHeroBg(); // Initial
    setInterval(changeHeroBg, 5000); // Change every 5 seconds
});
</script>
<style>
.page-wrapper {
    background: url("{% static 'images/road1.jpg' %}") center center/cover no-repeat fixed !important;
}
body {
    background: none !important;
}

.hero {
    background: transparent !important;
    box-shadow: none !important;
}

body {
    background: url("{% static 'images/road1.jpg' %}") center center/cover no-repeat fixed;
    min-height: 100vh;
}
.hero-content {
    background: url("{% static 'images/city1.jpg' %}") center center/cover no-repeat;
    border-radius: 28px;
    box-shadow: 0 8px 40px 0 rgba(31, 38, 135, 0.20);
    animation: fadeIn 1s cubic-bezier(.77,0,.18,1);
    backdrop-filter: blur(14px) saturate(140%);
    padding: 3.5rem 2rem 2.5rem 2rem;
    max-width: 600px;
    margin: 0 auto;
}

body {
    background: none !important;
}
.page-wrapper, main, header, section {
    background: transparent !important;
}
body::before {
    content: '';
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(255,255,255,0.4); /* More transparent overlay */
    z-index: 1;
    pointer-events: none;
}
.page-wrapper, main, header, section, footer {
    position: relative;
    z-index: 2;
}

</style>
{% block content %}
<!-- Dashboard Section -->
<!-- Hero Section -->
<header class="hero">
    <div class="hero-content">
        <h1>Welcome to Road Complaint Portal</h1>
        <p>Report road issues easily and help improve your community.</p>
    </div>
</header>

<!-- Features Section -->
<section class="features">
    <div class="feature">
        <i class="fas fa-file-alt fa-2x" style="color: #3f51b5; margin-bottom: 1rem;"></i>
        <h3>Easy Reporting</h3>
        <p>Submit complaints with images and location details.</p>
    </div>
    <div class="feature">
        <i class="fas fa-map-marked-alt fa-2x" style="color: #3f51b5; margin-bottom: 1rem;"></i>
        <h3>Interactive Map</h3>
        <p>View and track complaints on a real-time map.</p>
    </div>
    <div class="feature">
        <i class="fas fa-chart-line fa-2x" style="color: #3f51b5; margin-bottom: 1rem;"></i>
        <h3>Track Progress</h3>
        <p>Get updates on the status of your complaints.</p>
    </div>
</section>

<!--step section-->
<main>
    <div class="steps-section">
        <h2>How to Report an Issue</h2>
        <div class="steps-container">
            <div class="step">
                <div class="step-number">1</div>
                <h3>Login to Your Account</h3>
                <p>Create an account or login to start reporting issues</p>
            </div>
            <div class="step">
                <div class="step-number">2</div>
                <h3>Locate the Problem</h3>
                <p>Use the map to pinpoint the exact location of the issue</p>
            </div>
            <div class="step">
                <div class="step-number">3</div>
                <h3>Provide Details</h3>
                <p>Describe the issue and upload photos if available</p>
            </div>
            <div class="step">
                <div class="step-number">4</div>
                <h3>Submit Report</h3>
                <p>Submit your report and track its progress</p>
            </div>
        </div>
        <a href="{% url 'submit_complaint' %}" class="btn btn-primary report-complaint-btn">Report a Complaint</a>
    </div>
</main>
<!-- Reports Section: Side by Side -->
<section class="reports-section" style="margin: 2rem auto; max-width: 1200px;">
  <div style="display: flex; flex-wrap: wrap; gap: 2rem; justify-content: center; align-items: flex-start;">
    <!-- Complaints Bar Graph Card (with filter) -->
    <div style="flex: 1 1 350px; min-width: 340px; max-width: 500px; background: #fff; border-radius: 16px; box-shadow: 0 2px 8px #0001; padding: 1.5rem; display: flex; flex-direction: column;">
      <form id="reportFilterForm" method="get" style="display: flex; gap: 0.5rem; align-items: center; justify-content: flex-end; margin-bottom: 1rem;">
        <label for="filterPeriod" style="font-weight: 500; margin-right: 0.5rem;">Show Data For:</label>
        <select name="filter" id="filterPeriod" class="form-select" style="width: 160px;">
          <option value="7d" {% if filter == '7d' or not filter %}selected{% endif %}>Last 7 Days</option>
          <option value="month" {% if filter == 'month' %}selected{% endif %}>This Month</option>
          <option value="year" {% if filter == 'year' %}selected{% endif %}>This Year</option>
          <option value="custom_month" {% if filter == 'custom_month' %}selected{% endif %}>Custom Month</option>
          <option value="custom_year" {% if filter == 'custom_year' %}selected{% endif %}>Custom Year</option>
        </select>
        <input type="month" name="month" id="monthPicker" class="form-control" style="display:none; width:140px;" value="{{ month|default:'' }}">
        <input type="number" name="year" id="yearPicker" class="form-control" style="display:none; width:100px;" min="2000" max="2100" placeholder="Year" value="{{ year|default:'' }}">
        <button type="submit" class="btn btn-primary" style="padding: 4px 16px; font-size: 15px;">Apply</button>
      </form>
      <script>
      document.addEventListener('DOMContentLoaded', function() {
        const filterPeriod = document.getElementById('filterPeriod');
        const monthPicker = document.getElementById('monthPicker');
        const yearPicker = document.getElementById('yearPicker');
        function updatePickers() {
          monthPicker.style.display = (filterPeriod.value === 'custom_month') ? 'block' : 'none';
          yearPicker.style.display = (filterPeriod.value === 'custom_year') ? 'block' : 'none';
        }
        filterPeriod.addEventListener('change', updatePickers);
        updatePickers();
      });
      </script>
      <h2 class="text-center mb-3">Complaints Report</h2>
      <div style="width:100%; min-height: 320px; display: flex; align-items: center; justify-content: center;">
        <canvas id="complaints7DaysBarChart" height="320"></canvas>
      </div>
    </div>
    <!-- All-Time Pie Chart Card -->
    <div style="flex: 1 1 350px; min-width: 340px; max-width: 500px; background: #fff; border-radius: 16px; box-shadow: 0 2px 8px #0001; padding: 1.5rem; display: flex; flex-direction: column; justify-content: flex-start;">
      <h2 class="text-center mb-3">All-Time Complaint Status Distribution</h2>
      <div style="width:100%; min-height: 320px; display: flex; align-items: center; justify-content: center;">
        <canvas id="allTimePieChart" height="320"></canvas>
      </div>
    </div>
  </div>
</section>

<!-- Contact Section -->
<section class="contact">
    <h2>Need Help?</h2>
    <p>Contact us for support or inquiries.</p>
    <a href="mailto:support@roadcomplaint.com" class="btn btn-secondary">Contact Support</a>
</section>

<!-- Linking CSS and JS -->
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Chart.js for future charts (optional) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="{% static 'css/style.css' %}">
<script src="{% static 'js/script.js' %}"></script>
<script>
// Animated Counters
function animateCounter(id, end) {
    const el = document.getElementById(id);
    if (!el) return;
    let start = 0;
    const duration = 1000;
    const step = Math.ceil(end / (duration / 30));
    function update() {
        start += step;
        if (start >= end) {
            el.textContent = end;
        } else {
            el.textContent = start;
            requestAnimationFrame(update);
        }
    }
    update();
}

document.addEventListener('DOMContentLoaded', function() {
    // Animated Counters
    function animateCounter(id, end) {
        const el = document.getElementById(id);
        if (!el) return;
        let start = 0;
        const duration = 1000;
        const step = Math.ceil(end / (duration / 30));
        function update() {
            start += step;
            if (start >= end) {
                el.textContent = end;
            } else {
                el.textContent = start;
                requestAnimationFrame(update);
            }
        }
        update();
    }

    animateCounter('totalComplaints', parseInt('{{ total_complaints|default:0 }}', 10));
    animateCounter('pendingComplaints', parseInt('{{ pending_complaints|default:0 }}', 10));
    animateCounter('resolvedComplaints', parseInt('{{ resolved_complaints|default:0 }}', 10));

    // 7 Days Complaints Bar Chart
    const ctxBar = document.getElementById('complaints7DaysBarChart').getContext('2d');
    new Chart(ctxBar, {
        type: 'bar',
        data: {
            labels: ['Pending', 'In Progress', 'Resolved'],
            datasets: [{
                label: 'Count',
                data: [
                    parseInt("{{ complaints_7d_pending|default:0 }}", 10),
                    parseInt("{{ complaints_7d_in_progress|default:0 }}", 10),
                    parseInt("{{ complaints_7d_resolved|default:0 }}", 10)
                ],
                backgroundColor: [
                    'rgba(255,152,0,0.85)',  // orange
                    'rgba(33,150,243,0.85)', // blue
                    'rgba(76,175,80,0.85)'   // green
                ],
                borderColor: [
                    'rgba(255,152,0,1)',
                    'rgba(33,150,243,1)',
                    'rgba(76,175,80,1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let value = context.parsed.y;
                            return `Count: ${value}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Complaints'
                    }
                },
                x: {
                    title: {
                        display: false
                    }
                }
            }
        }
    });
    // All-Time Complaints Pie Chart
    const ctxPie = document.getElementById('allTimePieChart').getContext('2d');
    new Chart(ctxPie, {
        type: 'pie',
        data: {
            labels: ['Pending', 'In Progress', 'Resolved'],
            datasets: [{
                data: [
                    parseInt("{{ pending_complaints|default:0 }}", 10),
                    parseInt("{{ in_progress_complaints|default:0 }}", 10),
                    parseInt("{{ resolved_complaints|default:0 }}", 10)
                ],
                backgroundColor: [
                    'rgba(255,152,0,0.85)',  // orange
                    'rgba(33,150,243,0.85)', // blue
                    'rgba(76,175,80,0.85)'   // green
                ],
                borderColor: [
                    'rgba(255,152,0,1)',
                    'rgba(33,150,243,1)',
                    'rgba(76,175,80,1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom',
                    labels: {
                        font: { size: 15 }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let value = context.parsed;
                            return `${label}: ${value}`;
                        }
                    }
                }
            }
        }
    });
});
</script>

{% endblock %}
